import{s as e}from"./store-BQ3slDKj.js";import{u}from"./index-BwvoFoZH.js";import{u as g,c as s,f as A,j as i,y as k,r as y}from"./index-D_nuE6M8.js";import{u as D,t as N}from"./terminal-CNqIwQ-w.js";import{H as p}from"./vue-DTj65VEW.js";const m="/admin/module/",b="/api/v6.store/";function S(a={}){return s({url:m+"index",method:"get",params:a})}function x(a={}){const o=g();return s({url:o.apiUrl+b+"modules",method:"get",params:a})}function v(a){const o=u(),t=g();return s({url:t.apiUrl+b+"info",method:"get",params:a},{anotherToken:o.getToken("auth")})}function U(a={}){const o=u(),t=g();return s({url:t.apiUrl+b+"order",method:"post",params:a},{anotherToken:o.getToken("auth")})}function M(a,o){const t=u(),n=g();return s({url:n.apiUrl+b+"pay",method:"post",params:{order_id:a,pay_type:o}},{anotherToken:t.getToken("auth"),showSuccessMessage:!0})}function P(a){const o=u(),t=g();return s({url:t.apiUrl+"/api/pay/check",method:"get",params:{sn:a}},{anotherToken:o.getToken("auth"),showCodeMessage:!1})}function O(a){return s({url:m+"state",method:"get",params:{uid:a}})}function R(a,o,t={}){const n=u();return s({url:m+"install",method:"post",params:{uid:a,orderId:o,token:n.getToken("auth")},data:{extend:t},timeout:3e3*10},{showCodeMessage:!1})}function H(a,o,t={}){const n=u();return s({url:m+"update",method:"POST",params:{uid:a,orderId:o,token:n.getToken("auth")},data:{extend:t},timeout:3e3*10})}function K(a){return s({url:m+"uninstall",method:"post",params:{uid:a}},{showSuccessMessage:!0})}function _(a){return s({url:m+"changeState",method:"post",data:a},{showCodeMessage:!1})}function J(a){return s({url:m+"dependentInstallComplete",method:"post",params:{uid:a}})}function Q(a){const o=u();return s({url:m+"upload",method:"post",params:{file:a,token:o.getToken("auth")}})}var d=(a=>(a[a.UNINSTALLED=0]="UNINSTALLED",a[a.INSTALLED=1]="INSTALLED",a[a.WAIT_INSTALL=2]="WAIT_INSTALL",a[a.CONFLICT_PENDING=3]="CONFLICT_PENDING",a[a.DEPENDENT_WAIT_INSTALL=4]="DEPENDENT_WAIT_INSTALL",a[a.DIRECTORY_OCCUPIED=5]="DIRECTORY_OCCUPIED",a[a.DISABLE=6]="DISABLE",a))(d||{});const W=()=>{e.loading.table=!0,e.table.indexLoaded?E():B().then(()=>{E()})},r=()=>{e.table.indexLoaded=!1;for(const a in e.table.modulesEbak)e.table.modulesEbak[a]=void 0;W()},B=()=>S().then(a=>{e.table.indexLoaded=!0,e.sysVersion=a.data.sysVersion,e.installedModule=a.data.installed;const o=[];if(a.data.installed){for(const t in a.data.installed)o.push(a.data.installed[t].uid);e.installedModuleUids=o}}),E=()=>{if(typeof e.table.modulesEbak[e.table.params.activeTab]<"u"){e.table.modules[e.table.params.activeTab]=L(e.table.modulesEbak[e.table.params.activeTab]),e.loading.table=!1;return}const a={};for(const n in e.table.params)e.table.params[n]!=""&&(a[n]=e.table.params[n]);const o=[],t=[];e.installedModule.forEach(n=>{t.push({uid:n.uid,version:n.version})}),a.installed=t,a.sysVersion=e.sysVersion,x(a).then(n=>{a.activeTab=="all"&&(n.data.rows.forEach(l=>{o.push(l.uid)}),e.installedModule.forEach(l=>{o.indexOf(l.uid)===-1&&(e.table.params.quickSearch?l.title.includes(e.table.params.quickSearch)&&n.data.rows.push(l):n.data.rows.push(l))})),e.table.remark=n.data.remark,e.table.modulesEbak[a.activeTab]=n.data.rows.map(l=>{const c=e.installedModuleUids.indexOf(l.uid);return c!==-1?(l.state=e.installedModule[c].state,l.version=e.installedModule[c].version,l.website=e.installedModule[c].website,l.stateTag=V(l.state)):l.state=0,l.new_version&&l.tags&&l.tags.push({name:i.global.t("module.New version"),type:"danger"}),l}),e.table.modules[a.activeTab]=L(e.table.modulesEbak[a.activeTab]),e.table.category=n.data.category}).finally(()=>{e.loading.table=!1})},C=a=>{e.dialog.goodsInfo=!0,e.loading.goodsInfo=!0;const o=e.installedModule.find(t=>t.uid==a);v({uid:a,localVersion:o==null?void 0:o.version,sysVersion:e.sysVersion}).then(t=>{o?(t.data.info.type=="local"?(t.data.info=o,t.data.info.images=[A("/static/images/local-module-logo.png")],t.data.info.type="local"):(t.data.info.type="online",t.data.info.state=o.state,t.data.info.version=o.version),t.data.info.enable=o.state!==d.DISABLE):(t.data.info.state=0,t.data.info.type="online"),e.goodsInfo=t.data.info}).catch(t=>{h(t)&&(e.dialog.goodsInfo=!1)}).finally(()=>{e.loading.goodsInfo=!1})},X=(a=!1)=>{e.dialog.buy=!0,e.loading.buy=!0,U({goods_id:e.goodsInfo.id}).then(o=>{e.loading.buy=!1,e.buy.renew=a,e.buy.info=o.data.info}).catch(o=>{e.dialog.buy=!1,e.loading.buy=!1,h(o)})},Z=a=>{e.common.payType=a,e.loading.common=!0,M(e.buy.info.id,a).then(o=>{if(e.dialog.buy=!1,e.dialog.goodsInfo=!1,a=="wx"||a=="zfb"){e.dialog.pay=!0,e.payInfo=o.data;const t=setInterval(()=>{P(e.payInfo.info.sn).then(()=>{e.payInfo.pay.status="success",clearInterval(t),e.buy.renew?C(o.data.info.uid):T(o.data.info.uid,o.data.info.id),e.dialog.pay=!1}).catch(()=>{})},3e3)}else e.buy.renew?C(o.data.info.uid):T(o.data.info.uid,o.data.info.id)}).catch(o=>{h(o)}).finally(()=>{e.loading.common=!1})},I=a=>{e.common.type="loading",e.common.loadingTitle=a,e.common.loadingComponentKey=k()},T=(a,o)=>{e.dialog.common=!0,I("init"),e.common.dialogTitle=i.global.t("module.Install"),O(a).then(t=>{t.data.state===d.INSTALLED||t.data.state===d.DISABLE||t.data.state===d.DIRECTORY_OCCUPIED?(p({type:"error",message:t.data.state===d.INSTALLED||t.data.state===d.DISABLE?i.global.t("module.Installation cancelled because module already exists!"):i.global.t("module.Installation cancelled because the directory required by the module is occupied!")}),e.dialog.common=!1):(I(t.data.state===d.UNINSTALLED?"download":"install"),w(a,o),e.dialog.baAccount=!1,e.dialog.buy=!1,e.dialog.goodsInfo=!1)})},w=(a,o,t={})=>{R(a,o,t).then(()=>{e.common.dialogTitle=i.global.t("module.Installation complete"),e.common.moduleState=d.INSTALLED,e.common.type="done",r()}).catch(n=>{if(!h(n))if(n.code==-1)e.common.uid=n.data.uid,e.common.type="InstallConflict",e.common.dialogTitle=i.global.t("module.A conflict is found Please handle it manually"),e.common.fileConflict=n.data.fileConflict,e.common.dependConflict=n.data.dependConflict;else if(n.code==-2){e.common.type="done",e.common.uid=n.data.uid,e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=d.DEPENDENT_WAIT_INSTALL,e.common.waitInstallDepend=n.data.wait_install,e.common.dependInstallState="executing";const l=D();n.data.wait_install.includes("npm_dependent_wait_install")&&l.addTaskPM("web-install",!0,"module-install:"+n.data.uid,c=>{f(c,"npm_dependent_wait_install")}),n.data.wait_install.includes("nuxt_npm_dependent_wait_install")&&l.addTaskPM("nuxt-install",!0,"module-install:"+n.data.uid,c=>{f(c,"nuxt_npm_dependent_wait_install")}),n.data.wait_install.includes("composer_dependent_wait_install")&&l.addTask("composer.update",!0,"module-install:"+n.data.uid,c=>{f(c,"composer_dependent_wait_install")})}else n.code==0&&(p({type:"error",message:n.msg,zIndex:9999}),e.dialog.common=!1,r())}).finally(()=>{e.loading.common=!1})},f=(a,o)=>{a==N.Success?(e.common.waitInstallDepend=e.common.waitInstallDepend.filter(t=>t!=o),e.common.waitInstallDepend.length==0&&(e.common.dependInstallState="success",y.currentRoute.value.name==="moduleStore/moduleStore"&&r())):(D().toggle(!0),e.common.dependInstallState="fail",y.currentRoute.value.name==="moduleStore/moduleStore"&&r()),y.currentRoute.value.name},$=(a=!1)=>{if(e.loading.common=!0,a){const o={};for(const t in e.common.disableDependConflict)e.common.disableDependConflict[t].solution=="delete"&&(typeof o[e.common.disableDependConflict[t].env]>"u"&&(o[e.common.disableDependConflict[t].env]=[]),o[e.common.disableDependConflict[t].env].push(e.common.disableDependConflict[t].depend));e.common.disableParams.confirmConflict=1,e.common.disableParams.dependConflictSolution=o}_(e.common.disableParams).then(()=>{p({type:"success",message:i.global.t("module.The operation succeeds Please clear the system cache and refresh the browser ~"),zIndex:9999}),e.dialog.common=!1,r()}).catch(o=>{if(o.code==-1){if(e.dialog.common=!0,e.common.dialogTitle=i.global.t("module.Deal with conflict"),e.common.type="disableConfirmConflict",e.common.disableDependConflict=o.data.dependConflict,o.data.conflictFile&&o.data.conflictFile.length){const t=[];for(const n in o.data.conflictFile)t.push({file:o.data.conflictFile[n]});e.common.disableConflictFile=t}}else if(o.code==-2){e.dialog.common=!0;const t={commands:o.data.wait_install};e.common.uid=e.goodsInfo.uid,F(t)}else o.code==-3?T(e.goodsInfo.uid,e.goodsInfo.purchased):(p({type:"error",message:o.msg,zIndex:9999}),r())}).finally(()=>{e.loading.common=!1})},ee=a=>{e.loading.common=!0,_({uid:a,state:1}).then(()=>{e.dialog.common=!0,I("init"),e.common.dialogTitle=i.global.t("Enable"),w(a,0),e.dialog.goodsInfo=!1}).catch(o=>{p({type:"error",message:o.msg,zIndex:9999})})},h=a=>{const o=u();return a.code==301||a.code==408?(o.removeToken(),e.dialog.baAccount=!0,!0):!1},L=a=>e.table.onlyLocal?a.filter(o=>o.state>d.UNINSTALLED):a,F=a=>{{e.dialog.common=!0,e.common.type="done",e.common.dialogTitle=i.global.t("module.Wait for dependent installation"),e.common.moduleState=d.DISABLE,e.common.dependInstallState="executing";const o=D();a.commands.forEach(t=>{e.common.waitInstallDepend.push(t.type),t.pm?(t.command=="web-install",o.addTaskPM(t.command,!0,"",n=>{f(n,t.type),t.command=="web-install"})):o.addTask(t.command,!0,"",n=>{f(n,t.type)})})}},ae=a=>a.nickname+"（"+(a.email||a.mobile||"ID:"+a.id)+"）",oe=(a,o)=>typeof a>"u"||typeof o>"u"?"-":o==0?parseInt(a.toString())+i.global.t("Integral"):"￥"+a,V=a=>{switch(a){case d.INSTALLED:return{type:"",text:i.global.t("module.installed")};case d.WAIT_INSTALL:return{type:"success",text:i.global.t("module.Wait for installation")};case d.CONFLICT_PENDING:return{type:"danger",text:i.global.t("module.Conflict pending")};case d.DEPENDENT_WAIT_INSTALL:return{type:"warning",text:i.global.t("module.Dependency to be installed")};case d.DISABLE:return{type:"warning",text:i.global.t("Disable")};default:return{type:"info",text:i.global.t("Unknown")}}};export{T as a,r as b,oe as c,J as d,w as e,$ as f,X as g,C as h,ee as i,O as j,H as k,h as l,d as m,W as n,Z as o,K as p,ae as s,Q as u};
